<style>
  /* ===== CurlByRoaa ‚Äî Hair Care Genius (Mobile-first, animation-forward) ===== */
  .hair-quiz { padding: 48px 16px; background: linear-gradient(135deg, #FAF8F6 0%, #FFFFFF 100%); }
  .quiz-container { max-width: 900px; margin: 0 auto; background: #fff; border-radius: 20px; padding: 28px; box-shadow: 0 18px 48px rgba(13,20,25,0.06); overflow: hidden; }

  /* Progress */
  .quiz-progress { margin-bottom: 18px; }
  .progress-header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:8px; }
  .progress-text{ font-size:0.85rem; color:#6b6b6b; font-weight:600; }
  .progress-bar{ height:6px; background:#f2f2f2; border-radius:999px; overflow:hidden; }
  .progress-fill{ height:100%; width:0%; background:linear-gradient(90deg,#E8C4B8,#D4A59A); transition:width 450ms cubic-bezier(.2,.8,.2,1); }

  /* Steps */
  .quiz-step{ display:none; }
  .quiz-step.active{ display:block; animation: slideInUp 420ms cubic-bezier(.2,.8,.2,1); }
  .quiz-question{ font-size:1.25rem; font-weight:700; color:#222; text-align:center; margin:18px 0 22px; line-height:1.2; }

  .quiz-options{ display:grid; gap:12px; margin-bottom:18px; }
  .quiz-option{ display:flex; gap:12px; align-items:center; padding:14px; border-radius:14px; background:#fff; border:1px solid #f0f0f0; cursor:pointer; transition:transform 260ms ease, box-shadow 260ms ease, border-color 260ms ease; }
  .quiz-option .option-image{ min-width:56px; min-height:56px; border-radius:12px; display:grid; place-items:center; font-size:1.4rem; background:#fbf9f8; }
  .quiz-option .option-body{ flex:1; }
  .option-text{ font-weight:700; color:#222; margin-bottom:4px; }
  .option-description{ font-size:0.9rem; color:#666; line-height:1.3; }

  .quiz-option:hover{ transform:translateY(-4px); box-shadow:0 10px 30px rgba(13,20,25,0.06); border-color:#ead1c6; }
  .quiz-option.selected{ border-color:#E8C4B8; background:linear-gradient(180deg,#FFF8F6,#FFFFFF); box-shadow:0 14px 36px rgba(232,196,184,0.12); }
  .quiz-option.selected::after{ content:"‚úì"; display:inline-grid; place-items:center; width:28px; height:28px; background:#E8C4B8; color:#fff; border-radius:999px; font-weight:700; margin-left:8px; }

  /* Navigation */
  .quiz-navigation{ display:flex; gap:12px; margin-top:6px; }
  .quiz-btn{ flex:1; padding:12px 14px; border-radius:999px; font-weight:700; font-size:0.92rem; border:1px solid #E8C4B8; background:#fff; color:#E8C4B8; cursor:pointer; transition:transform 220ms ease, box-shadow 220ms ease; text-transform:uppercase; letter-spacing:.6px; }
  .quiz-btn:disabled{ opacity:0.55; cursor:not-allowed; transform:none; }
  .quiz-btn.next{ background:linear-gradient(90deg,#E8C4B8,#D4A59A); color:#fff; border:none; }
  .quiz-btn.next:hover:not(:disabled){ transform:translateX(4px); box-shadow:0 12px 30px rgba(212,165,154,0.22); }

  /* Results */
  .quiz-results{ display:none; text-align:center; padding-top:8px; }
  .quiz-results.active{ display:block; animation:fadeIn 480ms ease; }
  .results-title{ font-size:1.6rem; font-weight:800; color:#222; margin-bottom:6px; }
  .results-subtitle{ color:#666; margin-bottom:18px; font-size:0.98rem; line-height:1.4; }

  .recommended-products{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:18px; }
  .recommended-product{ display:flex; gap:12px; align-items:center; padding:12px; border-radius:12px; background:#fff; border:1px solid #f2f2f2; box-shadow:0 6px 18px rgba(13,20,25,0.04); transition:transform 260ms ease; }
  .recommended-product:hover{ transform:translateY(-6px); }
  .product-thumb{ width:64px; height:64px; border-radius:10px; object-fit:cover; background:#f6f6f6; }
  .product-meta{ flex:1; text-align:left; }
  .product-name{ font-weight:700; color:#222; margin-bottom:6px; }
  .product-desc{ font-size:0.9rem; color:#666; margin-bottom:6px; }
  .product-cta{ font-weight:700; color:#E8C4B8; text-decoration:none; font-size:0.95rem; }

  .small-muted{ font-size:0.85rem; color:#8a8a8a; margin-top:8px; }

  /* Animations */
  @keyframes slideInUp{ from{ transform:translateY(18px); opacity:0 } to{ transform:translateY(0); opacity:1 } }
  @keyframes fadeIn{ from{ opacity:0 } to{ opacity:1 } }

  /* Mobile-first layout tweaks */
  @media (min-width:720px){ .quiz-options{ grid-template-columns:1fr 1fr } .recommended-products{ grid-template-columns:repeat(2,1fr) } .quiz-container{ padding:36px } .quiz-question{ font-size:1.45rem } }
</style>

<section class="hair-quiz">
  <div class="quiz-container" id="hair-quiz-root">
    <!-- PROGRESS -->
    <div class="quiz-progress">
      <div class="progress-header">
        <span class="progress-text">{{ section.settings.title | default: "Find Your Perfect Routine" }}</span>
        <span class="progress-text"><span id="current-step">1</span>/<span id="total-steps">3</span></span>
      </div>
      <div class="progress-bar" aria-hidden="true">
        <div class="progress-fill" id="quiz-progress"></div>
      </div>
    </div>

    <!-- STEPS -->
    <div class="quiz-step active" data-step="1" aria-hidden="false">
      <h3 class="quiz-question">What's your natural curl pattern?</h3>
      <div class="quiz-options" role="list">
        <div class="quiz-option" role="listitem" data-value="wavy" tabindex="0">
          <div class="option-image">üåä</div>
          <div class="option-body"><div class="option-text">Wavy</div><div class="option-description">Loose S-shaped curls (2A‚Äì2C)</div></div>
        </div>
        <div class="quiz-option" role="listitem" data-value="curly" tabindex="0">
          <div class="option-image">üåÄ</div>
          <div class="option-body"><div class="option-text">Curly</div><div class="option-description">Defined spiral curls (3A‚Äì3C)</div></div>
        </div>
        <div class="quiz-option" role="listitem" data-value="coily" tabindex="0">
          <div class="option-image">‚ú®</div>
          <div class="option-body"><div class="option-text">Coily</div><div class="option-description">Tight zig-zag pattern (4A‚Äì4C)</div></div>
        </div>
      </div>
      <div class="quiz-navigation">
        <button class="quiz-btn prev" disabled aria-disabled="true">Back</button>
        <button class="quiz-btn next" disabled aria-disabled="true">Continue</button>
      </div>
    </div>

    <div class="quiz-step" data-step="2" aria-hidden="true">
      <h3 class="quiz-question">What's your biggest hair concern?</h3>
      <div class="quiz-options" role="list">
        <div class="quiz-option" role="listitem" data-value="frizz" tabindex="0"><div class="option-image">üí®</div><div class="option-body"><div class="option-text">Frizz & Flyaways</div><div class="option-description">Humidity or dryness causing frizz</div></div></div>
        <div class="quiz-option" role="listitem" data-value="moisture" tabindex="0"><div class="option-image">üíß</div><div class="option-body"><div class="option-text">Dryness & Hydration</div><div class="option-description">Hair feels thirsty or brittle</div></div></div>
        <div class="quiz-option" role="listitem" data-value="definition" tabindex="0"><div class="option-image">üéØ</div><div class="option-body"><div class="option-text">Curl Definition</div><div class="option-description">Want springs & bounce</div></div></div>
        <div class="quiz-option" role="listitem" data-value="volume" tabindex="0"><div class="option-image">üîº</div><div class="option-body"><div class="option-text">Volume & Lift</div><div class="option-description">Flat roots or limp hair</div></div></div>
      </div>
      <div class="quiz-navigation">
        <button class="quiz-btn prev">Back</button>
        <button class="quiz-btn next" disabled>Continue</button>
      </div>
    </div>

    <div class="quiz-step" data-step="3" aria-hidden="true">
      <h3 class="quiz-question">How dense is your hair?</h3>
      <div class="quiz-options" role="list">
        <div class="quiz-option" role="listitem" data-value="fine" tabindex="0"><div class="option-image">üçÉ</div><div class="option-body"><div class="option-text">Fine</div><div class="option-description">Thin strands, can get weighed down</div></div></div>
        <div class="quiz-option" role="listitem" data-value="medium" tabindex="0"><div class="option-image">üåø</div><div class="option-body"><div class="option-text">Medium</div><div class="option-description">Balanced, versatile</div></div></div>
        <div class="quiz-option" role="listitem" data-value="thick" tabindex="0"><div class="option-image">üå≥</div><div class="option-body"><div class="option-text">Thick</div><div class="option-description">Dense hair, needs stronger hold</div></div></div>
      </div>
      <div class="quiz-navigation">
        <button class="quiz-btn prev">Back</button>
        <button class="quiz-btn next" disabled>See My Routine</button>
      </div>
    </div>

    <div class="quiz-step quiz-results" data-step="results" aria-hidden="true">
      <h3 class="results-title">Your Personalized Hair Routine</h3>
      <p class="results-subtitle" id="results-summary">Our HairCare Genius analyzed your profile and created a professional routine and product picks tailored to you.</p>
      <div id="scientific-insight" class="small-muted"></div>
      <div class="recommended-products" id="recommended-products" aria-live="polite"></div>
      <div class="quiz-navigation" style="margin-top:18px;">
        <a id="shop-recommended" class="quiz-btn" href="{{ routes.all_products_collection_url }}">Shop Recommended Products</a>
        <button class="quiz-btn next" onclick="restartQuiz()">Try Again</button>
      </div>
    </div>

  </div>
</section>

<!-- ============ DYNAMIC PRODUCT JSON (THEME-CHECK SAFE) ============ -->
{%- comment -%}
  Inject a JSON array of products safely.
  We use the all_products_collection_url as a fallback source; Theme Check‚Äìsafe Liquid with image_url filter.
{%- endcomment -%}

<script type="application/json" id="curlbyroaa-products">
[
{%- assign fallback_collection = collections.all -%}
{%- for product in fallback_collection.products limit: 50 -%}
  {
    "id": {{ product.id | json }},
    "title": {{ product.title | json }},
    "handle": {{ product.handle | json }},
    "url": {{ product.url | json }},
    "image": {{ product.featured_image | image_url: width: 600 | json }},
    "price": {{ product.variants.first.price | json }},
    "tags": {{ product.tags | json }}
  }{%- unless forloop.last -%},{%- endunless -%}
{%- endfor -%}
]
</script>

<script>
/* CurlByRoaa ‚Äî HairCare Genius (Dynamic-safe)
   - Parses product JSON injected by Liquid from collections.all (limited to 50)
   - Mobile-first UX with instant local recommendations, optional AI override
*/

/* Parse products safely from the injected JSON script tag */
function getProductsFromInjectedJSON() {
  try {
    const el = document.getElementById('curlbyroaa-products');
    if (!el) return [];
    const raw = el.textContent.trim();
    if (!raw) return [];
    const parsed = JSON.parse(raw);
    return parsed.map(p => ({
      id: p.id || null,
      title: p.title || 'Product',
      handle: p.handle || '',
      url: p.url || '',
      image: p.image || '',
      price: p.price || '',
      tags: Array.isArray(p.tags) ? p.tags.map(t => t.toString().toLowerCase()) : []
    }));
  } catch (err) {
    console.warn('Failed to parse injected product JSON', err);
    return [];
  }
}

const productsList = getProductsFromInjectedJSON();

/* Local recommendation engine */
function localRecommendationEngine(answers) {
  const tags = new Set();
  const concernTagMap = { 'frizz':['frizz-control','anti-frizz','humidity-shield'], 'moisture':['hydration','moisture','deep-conditioning'], 'definition':['curl-definition','styling','hold'], 'volume':['volume','root-lift','lightweight'] };
  const typeMap = { 'wavy':['lightweight','definition'], 'curly':['hydration','definition'], 'coily':['rich','deep-conditioning','moisture'] };
  const densityMap = { 'fine':['lightweight'], 'medium':['balanced'], 'thick':['rich','strong-hold'] };

  const concern = answers.step2; const type = answers.step1; const density = answers.step3;
  if (concern && concernTagMap[concern]) concernTagMap[concern].forEach(t => tags.add(t));
  if (type && typeMap[type]) typeMap[type].forEach(t => tags.add(t));
  if (density && densityMap[density]) densityMap[density].forEach(t => tags.add(t));
  tags.add('salon-picked');

  const scored = productsList.map(p => {
    let score = 0;
    for (let t of tags) if (p.tags.includes(t)) score++;
    return Object.assign({}, p, { score });
  }).filter(p => p.score > 0).sort((a,b) => b.score - a.score);

  const fallback = productsList.slice(0,6).map(p => Object.assign({}, p, { score:0 }));
  return scored.length ? scored.slice(0,6) : fallback;
}

/* Optional AI call placeholder (no Liquid) */
async function callAIService(answers) {
  try {
    const endpoint = ''; // <-- set your AI endpoint URL here
    if (!endpoint) return null;
    const res = await fetch(endpoint, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ answers, source:'curlbyroaa-haircare-genius' }) });
    if (!res.ok) throw new Error('AI service error');
    return await res.json();
  } catch (err) { console.warn('AI call failed', err); return null; }
}

/* Main UI & Interaction */
class HairCareGenius {
  constructor(root) {
    this.root = root; this.currentStep = 1; this.totalSteps = 3; this.answers = {};
    this.bind(); this.updateProgress(); this.keyboardBind();
  }

  bind() {
    this.root.querySelectorAll('.quiz-option').forEach(opt => {
      opt.addEventListener('click', (e) => this.selectOption(e.currentTarget));
      opt.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); this.selectOption(e.currentTarget); }});
    });
    this.root.querySelectorAll('.quiz-btn.next').forEach(btn => btn.addEventListener('click', () => this.nextStep()));
    this.root.querySelectorAll('.quiz-btn.prev').forEach(btn => btn.addEventListener('click', () => this.prevStep()));
  }

  keyboardBind() {
    document.addEventListener('keydown', (e) => {
      if (['ArrowRight','ArrowDown','ArrowLeft','ArrowUp'].includes(e.key)) {
        const activeStepEl = this.root.querySelector(`.quiz-step[data-step="${this.currentStep}"]`);
        if (!activeStepEl) return;
        const opts = Array.from(activeStepEl.querySelectorAll('.quiz-option'));
        if (!opts.length) return;
        const focused = document.activeElement; let idx = opts.indexOf(focused);
        if (idx === -1) idx = 0;
        if (e.key === 'ArrowRight' || e.key === 'ArrowDown') idx = (idx + 1) % opts.length;
        if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') idx = (idx - 1 + opts.length) % opts.length;
        opts[idx].focus();
      }
    });
  }

  selectOption(el) {
    const value = el.getAttribute('data-value'); const step = this.currentStep;
    el.parentElement.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected'));
    el.classList.add('selected'); this.answers[`step${step}`] = value;
    const visibleNext = this.root.querySelector(`.quiz-step[data-step="${step}"] .quiz-btn.next`);
    if (visibleNext) { visibleNext.disabled = false; visibleNext.setAttribute('aria-disabled','false'); }
  }

  showStep(n) {
    const prevEl = this.root.querySelector(`.quiz-step[data-step="${this.currentStep}"]`); if (prevEl) { prevEl.classList.remove('active'); prevEl.setAttribute('aria-hidden','true'); }
    this.currentStep = n;
    const el = this.root.querySelector(`.quiz-step[data-step="${this.currentStep}"]`); if (el) { el.classList.add('active'); el.setAttribute('aria-hidden','false');
      const nextBtn = el.querySelector('.quiz-btn.next'); if (nextBtn) { nextBtn.disabled = !this.answers[`step${this.currentStep}`]; nextBtn.setAttribute('aria-disabled', nextBtn.disabled ? 'true':'false'); }
    }
    this.root.querySelectorAll('.quiz-btn.prev').forEach(b => { b.disabled = this.currentStep === 1; b.setAttribute('aria-disabled', b.disabled ? 'true':'false'); });
    document.getElementById('current-step').textContent = this.currentStep; this.updateProgress();
  }

  nextStep() { if (this.currentStep < this.totalSteps) { this.showStep(this.currentStep + 1); } else { this.finish(); } }
  prevStep() { if (this.currentStep > 1) this.showStep(this.currentStep - 1); }

  updateProgress() { const pct = ((this.currentStep - 1) / this.totalSteps) * 100; document.getElementById('quiz-progress').style.width = pct + '%'; document.getElementById('total-steps').textContent = this.totalSteps; }

  async finish() {
    const curEl = this.root.querySelector(`.quiz-step[data-step="${this.currentStep}"]`); if (curEl) { curEl.classList.remove('active'); curEl.setAttribute('aria-hidden','true'); }
    const resultsEl = this.root.querySelector('.quiz-results'); resultsEl.classList.add('active'); resultsEl.setAttribute('aria-hidden','false');

    const summary = document.getElementById('results-summary'); summary.textContent = 'Analyzing your answers ‚Äî generating science-backed routine...';

    const localPicks = localRecommendationEngine({ step1:this.answers.step1, step2:this.answers.step2, step3:this.answers.step3 });
    this.renderRecommendations(localPicks, 'Local recommendation (instant)');

    const aiResp = await callAIService(this.answers);
    if (aiResp && aiResp.products && aiResp.products.length) {
      const mapped = aiResp.products.map(p => {
        const found = productsList.find(sp => sp.handle === (p.handle || '').toString());
        return found ? found : Object.assign({ title:p.title||'Product', image:p.image||'', reason:p.reason||'' }, p);
      });
      this.renderRecommendations(mapped, 'AI-generated recommendation');
      if (aiResp.diagnosis) document.getElementById('scientific-insight').textContent = aiResp.diagnosis;
      if (aiResp.insight) document.getElementById('results-summary').textContent = aiResp.insight;
    } else {
      document.getElementById('scientific-insight').textContent = this.generateInsight(this.answers);
      document.getElementById('results-summary').textContent = 'Below are salon-selected products & a professional routine tailored to your answers.';
    }

    const shopBtn = document.getElementById('shop-recommended');
    const recommendedTags = this.extractTagsForShop(this.answers);
    if (recommendedTags.length) {
      const base = "{{ routes.search_url }}";
      const q = recommendedTags.map(t => `tag:${encodeURIComponent(t)}`).join('+');
      shopBtn.href = `${base}?q=${q}&type=product`;
    }
  }

  renderRecommendations(products, sourceLabel) {
    const container = document.getElementById('recommended-products'); container.innerHTML = '';
    if (!products || !products.length) { container.innerHTML = '<div class="small-muted">No recommendations found. Try editing your answers or contact CurlByRoaa salon for a professional consult.</div>'; return; }
    products.forEach(p => {
      const img = p.image || 'https://via.placeholder.com/300x300?text=Product';
      const productUrl = p.url || (p.handle ? `/products/${p.handle}` : '#');
      const desc = p.reason || (p.tags && p.tags.join(', ')) || 'Salon-recommended item';
      const el = document.createElement('div'); el.className = 'recommended-product';
      el.innerHTML = `<img class="product-thumb" src="${img}" alt="${this.escapeHtml(p.title||'Product')}" />
        <div class="product-meta"><div class="product-name">${this.escapeHtml(p.title||'Product')}</div>
        <div class="product-desc">${this.escapeHtml(desc)}</div>
        <a class="product-cta" href="${productUrl}">View product ‚Üí</a></div>`;
      container.appendChild(el);
    });
    const note = document.createElement('div'); note.className = 'small-muted'; note.textContent = `Recommendations: ${sourceLabel}`; container.appendChild(note);
  }

  extractTagsForShop(answers) {
    const tags = [];
    if (answers.step2 === 'frizz') tags.push('frizz-control');
    if (answers.step2 === 'moisture') tags.push('hydration');
    if (answers.step2 === 'definition') tags.push('curl-definition');
    if (answers.step2 === 'volume') tags.push('volume');
    if (answers.step1 === 'coily') tags.push('rich');
    if (answers.step1 === 'wavy') tags.push('lightweight');
    if (answers.step3 === 'fine') tags.push('lightweight');
    return tags;
  }

  generateInsight(answers) {
    const parts = [];
    if (answers.step2 === 'moisture') parts.push('Your curls need hydration ‚Äî prioritize water-based products with humectants and occlusives to lock moisture.');
    if (answers.step2 === 'frizz') parts.push('Humidity management: use anti-frizz emulsions and smoothing oils to reduce flyaways.');
    if (answers.step2 === 'definition') parts.push('Use lightweight gels/creams with reactivatable humectants for definition without crunch.');
    if (answers.step2 === 'volume') parts.push('Root-lifting sprays and lightweight mousses help volume without weighing hair down.');
    if (!parts.length) parts.push('A balanced routine with cleansing, conditioning, targeted treatment and weekly deep care will improve results.');
    return parts.join(' ');
  }

  escapeHtml(s) { return (s || '').toString().replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
}

/* Initialize after DOM ready */
document.addEventListener('DOMContentLoaded', () => { new HairCareGenius(document.getElementById('hair-quiz-root')); });

/* Simple restart helper */
function restartQuiz() { location.reload(); }
</script>

{% schema %}
{
  "name": "Hair Quiz",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Find Your Perfect Routine"
    }
  ],
  "presets": [
    {
      "name": "Numberc Style Quiz",
      "category": "Homepage"
    }
  ]
}
{% endschema %}
