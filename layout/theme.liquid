<!doctype html>
<html class="no-js" lang="{{ request.locale.iso_code }}">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  
  <!-- ADDED: Fix for mobile web app deprecation warning -->
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="{{ canonical_url }}">
  
  {{ content_for_header }}
  
  <!-- ADDED: Critical Content Security Policy fix for Shopify Cart -->
  <meta http-equiv="Content-Security-Policy" content="frame-ancestors 'self' https://admin.shopify.com https://shop.app https://*.shopify.com https://*.shopifyapps.com; default-src 'self' https://*.shopify.com https://*.shopifycdn.com https://shop.app;">
  
  {{ 'theme.css' | asset_url | stylesheet_tag }}
  
  <link rel="preconnect" href="https://cdn.shopify.com">
  <link rel="dns-prefetch" href="https://cdn.shopify.com">

  <style>
    @media (max-width: 767px) {
      html, body {
        overflow-x: hidden;
        width: 100%;
      }
      * {
        -webkit-tap-highlight-color: rgba(0,0,0,0.1);
      }
      .scrollable {
        -webkit-overflow-scrolling: touch;
      }
    }
    
    /* NEW: Main content wrapper for desktop adjustment */
    .content-wrapper {
      transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    }
    
    /* When sidebar is visible on desktop, shift content */
    @media (min-width: 1025px) {
      body.sidebar-desktop-visible .content-wrapper {
        margin-left: 350px; /* Same as sidebar width */
      }
      
      /* Smooth transition for content */
      main, .header-container {
        transition: margin-left 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
      }
      
      body.sidebar-desktop-visible main,
      body.sidebar-desktop-visible .header-container {
        margin-left: 350px;
      }
    }
  </style>
</head>

<body>
  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  
  <!-- Left Sidebar -->
  <aside class="sidebar" id="mainSidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <a href="{{ routes.root_url }}">
          <img 
            src="https://cdn.shopify.com/s/files/1/0567/4172/4316/files/logo.jpg?v=1764436849" 
            alt="{{ shop.name }}"
            width="120"
            height="40"
            loading="eager"
          >
        </a>
      </div>
      <button class="sidebar-close" id="sidebarClose" aria-label="Close sidebar">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    </div>
    
    <div class="sidebar-content">
      <nav class="sidebar-nav">
        <!-- Shop Dropdown -->
        <div class="sidebar-item">
          <a href="{{ routes.all_products_collection_url }}" class="sidebar-link">
            Shop
            <svg class="sidebar-arrow" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
            </svg>
          </a>
          <div class="sidebar-dropdown">
            <div class="sidebar-dropdown-section">
              <h4>By Product Type</h4>
              <div class="sidebar-dropdown-links">
                {%- assign collections_to_show = 'shampoo,conditioner,curl-cream,hair-oil,styling,treatments' | split: ',' -%}
                {%- for handle in collections_to_show -%}
                  {%- assign collection = collections[handle] -%}
                  <a href="{{ collection.url | default: routes.collections_url }}" class="sidebar-dropdown-link">
                    {%- if collection -%}
                      {{ collection.title }}
                    {%- else -%}
                      {{ handle | replace: '-', ' ' | capitalize }}
                    {%- endif -%}
                  </a>
                {%- endfor -%}
              </div>
            </div>
            <div class="sidebar-dropdown-section">
              <h4>By Curl Type</h4>
              <div class="sidebar-dropdown-links">
                {%- assign curl_collections = 'wavy-hair,curly-hair,coily-hair,fine-hair,thick-hair,damaged-hair' | split: ',' -%}
                {%- for handle in curl_collections -%}
                  {%- assign collection = collections[handle] -%}
                  <a href="{{ collection.url | default: routes.collections_url }}" class="sidebar-dropdown-link">
                    {%- if collection -%}
                      {{ collection.title }}
                    {%- else -%}
                      {{ handle | replace: '-', ' ' | capitalize }}
                    {%- endif -%}
                  </a>
                {%- endfor -%}
              </div>
            </div>
          </div>
        </div>

        <!-- Hair Quiz -->
        <div class="sidebar-item">
          <a href="#hair-quiz" class="sidebar-link">
            Hair Quiz
            <svg class="sidebar-arrow" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
            </svg>
          </a>
        </div>

        <!-- Services by Concern -->
        <div class="sidebar-item">
          <a href="#services-by-concern" class="sidebar-link">
            Services by Concern
          </a>
        </div>

        <!-- Our Story -->
        <div class="sidebar-item">
          <a href="{{ pages['about'].url | default: '/pages/about' }}" class="sidebar-link">
            Our Story
            <svg class="sidebar-arrow" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
            </svg>
          </a>
          <div class="sidebar-dropdown">
            <div class="sidebar-dropdown-section">
              <h4>About Us</h4>
              <div class="sidebar-dropdown-links">
                <a href="{{ pages['our-mission'].url | default: '/pages/our-mission' }}" class="sidebar-dropdown-link">Our Mission</a>
                <a href="{{ pages['our-story'].url | default: '/pages/our-story' }}" class="sidebar-dropdown-link">Brand Story</a>
                <a href="{{ pages['ingredients'].url | default: '/pages/ingredients' }}" class="sidebar-dropdown-link">Ingredient Philosophy</a>
                <a href="{{ pages['sustainability'].url | default: '/pages/sustainability' }}" class="sidebar-dropdown-link">Sustainability</a>
              </div>
            </div>
            <div class="sidebar-dropdown-section">
              <h4>Community</h4>
              <div class="sidebar-dropdown-links">
                <a href="{{ pages['curl-community'].url | default: '/pages/curl-community' }}" class="sidebar-dropdown-link">Curl Community</a>
                <a href="{{ pages['education'].url | default: '/pages/education' }}" class="sidebar-dropdown-link">Hair Education</a>
                <a href="{{ pages['events'].url | default: '/pages/events' }}" class="sidebar-dropdown-link">Events & Workshops</a>
                <a href="{{ pages['testimonials'].url | default: '/pages/testimonials' }}" class="sidebar-dropdown-link">Success Stories</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Guides -->
        <div class="sidebar-item">
          <a href="{{ blogs['guides'].url | default: '/blogs/guides' }}" class="sidebar-link">
            Guides
            <svg class="sidebar-arrow" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
            </svg>
          </a>
          <div class="sidebar-dropdown">
            <div class="sidebar-dropdown-section">
              <h4>Hair Care Guides</h4>
              <div class="sidebar-dropdown-links">
                {%- if blogs.guides.articles.size > 0 -%}
                  {%- for article in blogs.guides.articles limit: 4 -%}
                    <a href="{{ article.url }}" class="sidebar-dropdown-link">{{ article.title }}</a>
                  {%- endfor -%}
                {%- else -%}
                  <a href="{{ routes.blog_url }}" class="sidebar-dropdown-link">Wash Day Routine</a>
                  <a href="{{ routes.blog_url }}" class="sidebar-dropdown-link">Styling Techniques</a>
                  <a href="{{ routes.blog_url }}" class="sidebar-dropdown-link">Night Time Routine</a>
                  <a href="{{ routes.blog_url }}" class="sidebar-dropdown-link">Seasonal Hair Care</a>
                {%- endif -%}
              </div>
            </div>
            <div class="sidebar-dropdown-section">
              <h4>Expert Advice</h4>
              <div class="sidebar-dropdown-links">
                <a href="{{ routes.blog_url }}/tagged/common-mistakes" class="sidebar-dropdown-link">Common Mistakes</a>
                <a href="{{ routes.blog_url }}/tagged/application" class="sidebar-dropdown-link">Product Application</a>
                <a href="{{ routes.blog_url }}/tagged/troubleshooting" class="sidebar-dropdown-link">Troubleshooting Guide</a>
                <a href="{{ routes.blog_url }}/tagged/pro-tips" class="sidebar-dropdown-link">Professional Tips</a>
              </div>
            </div>
          </div>
        </div>
      </nav>
      
      <div class="sidebar-actions">
        <a href="{{ routes.account_login_url }}" class="sidebar-action-link">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
          </svg>
          <span>Account</span>
        </a>
        <a href="{{ routes.search_url }}" class="sidebar-action-link">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
          </svg>
          <span>Search</span>
        </a>
      </div>
    </div>
  </aside>

  <!-- NEW: Content Wrapper -->
  <div class="content-wrapper">
    {% section 'announcement-bar' %}
    {% section 'header' %}
    
    <main>
      {{ content_for_layout }}
    </main>

    {% section 'footer' %}
  </div>
  
  <!-- FIXED: Remove problematic theme.js and replace with standard Shopify scripts -->
  {{ '//cdn.shopify.com/s/javascripts/currencies.js' | script_tag }}
  {{ '//cdn.shopify.com/shopifycloud/shopify_common.js' | script_tag }}
  
  <!-- Sidebar CSS -->
  <style>
    /* Your existing sidebar CSS remains unchanged */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9998;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .sidebar-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    /* ... (rest of your sidebar CSS remains exactly as you have it) ... */
  </style>
  
  <!-- Sidebar JavaScript -->
  <script>
    class SidebarMenu {
      constructor() {
        this.sidebar = document.getElementById('mainSidebar');
        this.sidebarOverlay = document.getElementById('sidebarOverlay');
        this.sidebarClose = document.getElementById('sidebarClose');
        this.sidebarItems = document.querySelectorAll('.sidebar-item');
        this.sidebarLinks = document.querySelectorAll('.sidebar-link');
        this.isDesktop = window.innerWidth > 1024;
        this.isSidebarVisible = false;
        
        this.init();
      }

      init() {
        this.bindEvents();
        this.listenToHeaderEvents();
        this.handleResize();
      }

      bindEvents() {
        if (this.sidebarOverlay) {
          this.sidebarOverlay.addEventListener('click', () => {
            this.closeSidebar();
          });
        }

        if (this.sidebarClose) {
          this.sidebarClose.addEventListener('click', () => {
            this.closeSidebar();
          });
        }

        // Toggle dropdowns
        this.sidebarLinks.forEach(link => {
          if (link.nextElementSibling && link.nextElementSibling.classList.contains('sidebar-dropdown')) {
            link.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              const parent = link.parentElement;
              const isActive = parent.classList.contains('active');
              
              this.sidebarItems.forEach(item => {
                if (item !== parent) {
                  item.classList.remove('active');
                }
              });
              
              parent.classList.toggle('active');
              
              if (!isActive) {
                const dropdown = parent.querySelector('.sidebar-dropdown');
                dropdown.style.maxHeight = dropdown.scrollHeight + 'px';
              } else {
                parent.querySelector('.sidebar-dropdown').style.maxHeight = '0';
              }
            });
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.isSidebarVisible) {
            this.closeSidebar();
          }
        });
      }

      listenToHeaderEvents() {
        document.addEventListener('toggleSidebar', () => {
          this.toggleSidebar();
        });

        document.addEventListener('showSidebarOnScroll', () => {
          if (this.isDesktop) {
            this.showSidebarDesktop();
          }
        });

        document.addEventListener('hideSidebarOnScroll', () => {
          if (this.isDesktop) {
            this.hideSidebarDesktop();
          }
        });
      }

      toggleSidebar() {
        if (this.isSidebarVisible) {
          this.closeSidebar();
        } else {
          this.openSidebar();
        }
      }

      openSidebar() {
        this.sidebar.classList.add('active');
        if (this.sidebarOverlay) this.sidebarOverlay.classList.add('active');
        if (!this.isDesktop) {
          document.body.classList.add('sidebar-open');
        }
        document.body.style.overflow = 'hidden';
        this.isSidebarVisible = true;
      }

      closeSidebar() {
        this.sidebar.classList.remove('active');
        if (this.sidebarOverlay) this.sidebarOverlay.classList.remove('active');
        document.body.classList.remove('sidebar-open', 'sidebar-desktop-visible');
        document.body.style.overflow = '';
        this.isSidebarVisible = false;
        
        this.sidebarItems.forEach(item => {
          item.classList.remove('active');
          const dropdown = item.querySelector('.sidebar-dropdown');
          if (dropdown) dropdown.style.maxHeight = '0';
        });
      }

      showSidebarDesktop() {
        if (!this.isDesktop) return;
        
        this.sidebar.classList.add('desktop-auto-show');
        document.body.classList.add('sidebar-desktop-visible');
        this.isSidebarVisible = true;
        
        if (this.sidebarOverlay) this.sidebarOverlay.style.display = 'none';
        
        // Adjust container widths
        this.adjustContentContainers();
        
        this.sidebarItems.forEach(item => {
          item.classList.remove('active');
          const dropdown = item.querySelector('.sidebar-dropdown');
          if (dropdown) dropdown.style.maxHeight = '0';
        });
      }

      hideSidebarDesktop() {
        if (!this.isDesktop) return;
        
        this.sidebar.classList.remove('desktop-auto-show');
        document.body.classList.remove('sidebar-desktop-visible');
        this.isSidebarVisible = false;
        
        if (this.sidebarOverlay) this.sidebarOverlay.style.display = 'block';
        
        // Reset container widths
        this.resetContentContainers();
      }

      adjustContentContainers() {
        // Find common container classes and adjust them
        const containerSelectors = [
          '.page-width',
          '.container',
          '.shopify-section > div[class*="container"]',
          '.shopify-section > .section',
          '[class*="__container"]'
        ];
        
        containerSelectors.forEach(selector => {
          const containers = document.querySelectorAll(selector);
          containers.forEach(container => {
            if (!container.hasAttribute('data-original-margin')) {
              container.setAttribute('data-original-margin', container.style.marginLeft || '');
            }
            container.style.marginLeft = '350px';
            container.style.transition = 'margin-left 0.4s cubic-bezier(0.165, 0.84, 0.44, 1)';
            
            // Adjust width if needed
            const currentWidth = container.style.width || getComputedStyle(container).width;
            if (!container.hasAttribute('data-original-width')) {
              container.setAttribute('data-original-width', currentWidth);
            }
            if (container.classList.contains('page-width')) {
              container.style.maxWidth = `calc(100% - 350px)`;
            }
          });
        });
      }

      resetContentContainers() {
        const containerSelectors = [
          '.page-width',
          '.container',
          '.shopify-section > div[class*="container"]',
          '.shopify-section > .section',
          '[class*="__container"]'
        ];
        
        containerSelectors.forEach(selector => {
          const containers = document.querySelectorAll(selector);
          containers.forEach(container => {
            const originalMargin = container.getAttribute('data-original-margin');
            container.style.marginLeft = originalMargin || '';
            
            const originalWidth = container.getAttribute('data-original-width');
            if (originalWidth) {
              container.style.width = originalWidth;
              container.style.maxWidth = originalWidth.includes('max-width') ? originalWidth : '';
            }
          });
        });
      }

      handleResize() {
        window.addEventListener('resize', () => {
          const wasDesktop = this.isDesktop;
          this.isDesktop = window.innerWidth > 1024;
          
          if (wasDesktop !== this.isDesktop) {
            this.closeSidebar();
            this.sidebar.classList.remove('desktop-auto-show');
            document.body.classList.remove('sidebar-desktop-visible');
            this.resetContentContainers();
            
            if (this.sidebarOverlay) {
              this.sidebarOverlay.style.display = 'block';
            }
          }
        });
      }
    }

    // Initialize sidebar
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        const sidebar = new SidebarMenu();
        window.sidebarInstance = sidebar;
      }, 100);
    });
  </script>
</body>
</html>