<!doctype html>
<html class="no-js" lang="{{ request.locale.iso_code }}">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  
  <!-- Fix for mobile web app deprecation warning -->
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="{{ canonical_url }}">
  
  {{ content_for_header }} <!-- ONLY ONE HERE -->
  
  <!-- Load Shopify scripts for cart functionality -->
  <script src="https://cdn.shopify.com/shopifycloud/shopify-common.js" defer></script>
  
  {{ 'theme.css' | asset_url | stylesheet_tag }}
  
  <!-- Google Fonts if needed -->
  <!-- <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet"> -->
  
  <!-- Theme-check compliant preconnect -->
  <link rel="preconnect" href="https://cdn.shopify.com" crossorigin>

  <style>
    @media (max-width: 767px) {
      html, body {
        overflow-x: hidden;
        width: 100%;
      }
      * {
        -webkit-tap-highlight-color: rgba(0,0,0,0.1);
      }
      .scrollable {
        -webkit-overflow-scrolling: touch;
      }
    }
    
    /* Main content wrapper for desktop adjustment */
    .content-wrapper {
      transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    }
    
    /* When sidebar is visible on desktop, shift content */
    @media (min-width: 1025px) {
      body.sidebar-desktop-visible .content-wrapper {
        margin-left: 350px; /* Same as sidebar width */
      }
      
      /* Smooth transition for content */
      main, .header-container {
        transition: margin-left 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
      }
      
      body.sidebar-desktop-visible main,
      body.sidebar-desktop-visible .header-container {
        margin-left: 350px;
      }
    }
    
    /* UNIVERSAL BUTTON FIXES */
    [data-add-to-cart],
    .add-to-cart,
    .product-form__submit,
    [name="add"],
    .cart-btn,
    .btn-cart,
    .product-card button:not([type]),
    .collection-item button:not([type]),
    .grid-item button:not([type]) {
      cursor: pointer !important;
      position: relative;
      z-index: 5;
    }
    
    /* Book appointment buttons */
    [href*="book"],
    [href*="appointment"],
    [href*="sesami"],
    button:contains("Book"),
    a:contains("Book") {
      cursor: pointer !important;
    }
    
    /* Ensure buttons are visible and clickable */
    button:not(:disabled),
    a:not(:disabled) {
      pointer-events: auto !important;
    }
    
    /* Button handler animations */
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
  </style>
</head>

<body>
  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  
  <!-- Left Sidebar -->
  <aside class="sidebar" id="mainSidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <a href="{{ routes.root_url }}">
          <!-- Theme-check compliant logo using Shopify settings -->
          {% if settings.logo %}
            <img 
              src="{{ settings.logo | image_url: width: 120, height: 40, crop: 'center' }}" 
              alt="{{ shop.name }}"
              width="120"
              height="40"
              loading="eager"
            >
          {% else %}
            <span class="h2">{{ shop.name }}</span>
          {% endif %}
        </a>
      </div>
      <button class="sidebar-close" id="sidebarClose" aria-label="Close sidebar">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    </div>
    
    <div class="sidebar-content">
      <nav class="sidebar-nav">
        <!-- Shop Dropdown -->
        <div class="sidebar-item">
          <a href="{{ routes.all_products_collection_url }}" class="sidebar-link">
            Shop
            <svg class="sidebar-arrow" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
            </svg>
          </a>
          <div class="sidebar-dropdown">
            <div class="sidebar-dropdown-section">
              <h4>By Product Type</h4>
              <div class="sidebar-dropdown-links">
                {%- assign collections_to_show = 'shampoo,conditioner,curl-cream,hair-oil,styling,treatments' | split: ',' -%}
                {%- for handle in collections_to_show -%}
                  {%- assign collection = collections[handle] -%}
                  <a href="{{ collection.url | default: routes.collections_url }}" class="sidebar-dropdown-link">
                    {%- if collection -%}
                      {{ collection.title }}
                    {%- else -%}
                      {{ handle | replace: '-', ' ' | capitalize }}
                    {%- endif -%}
                  </a>
                {%- endfor -%}
              </div>
            </div>
            <div class="sidebar-dropdown-section">
              <h4>By Curl Type</h4>
              <div class="sidebar-dropdown-links">
                {%- assign curl_collections = 'wavy-hair,curly-hair,coily-hair,fine-hair,thick-hair,damaged-hair' | split: ',' -%}
                {%- for handle in curl_collections -%}
                  {%- assign collection = collections[handle] -%}
                  <a href="{{ collection.url | default: routes.collections_url }}" class="sidebar-dropdown-link">
                    {%- if collection -%}
                      {{ collection.title }}
                    {%- else -%}
                      {{ handle | replace: '-', ' ' | capitalize }}
                    {%- endif -%}
                  </a>
                {%- endfor -%}
              </div>
            </div>
          </div>
        </div>

        <!-- Hair Quiz -->
        <div class="sidebar-item">
          <a href="#hair-quiz" class="sidebar-link">
            Hair Quiz
            <svg class="sidebar-arrow" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
            </svg>
          </a>
        </div>

        <!-- Services by Concern -->
        <div class="sidebar-item">
          <a href="#services-by-concern" class="sidebar-link">
            Services by Concern
          </a>
          
        </div>

        <!-- Our Story -->
        <div class="sidebar-item">
          <a href="{{ pages['about'].url | default: '/pages/about' }}" class="sidebar-link">
            Our Story
            <svg class="sidebar-arrow" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
            </svg>
          </a>
          <div class="sidebar-dropdown">
            <div class="sidebar-dropdown-section">
              <h4>About Us</h4>
              <div class="sidebar-dropdown-links">
                <a href="{{ pages['our-mission'].url | default: '/pages/our-mission' }}" class="sidebar-dropdown-link">Our Mission</a>
                <a href="{{ pages['our-story'].url | default: '/pages/our-story' }}" class="sidebar-dropdown-link">Brand Story</a>
                <a href="{{ pages['ingredients'].url | default: '/pages/ingredients' }}" class="sidebar-dropdown-link">Ingredient Philosophy</a>
                <a href="{{ pages['sustainability'].url | default: '/pages/sustainability' }}" class="sidebar-dropdown-link">Sustainability</a>
              </div>
            </div>
            <div class="sidebar-dropdown-section">
              <h4>Community</h4>
              <div class="sidebar-dropdown-links">
                <a href="{{ pages['curl-community'].url | default: '/pages/curl-community' }}" class="sidebar-dropdown-link">Curl Community</a>
                <a href="{{ pages['education'].url | default: '/pages/education' }}" class="sidebar-dropdown-link">Hair Education</a>
                <a href="{{ pages['events'].url | default: '/pages/events' }}" class="sidebar-dropdown-link">Events & Workshops</a>
                <a href="{{ pages['testimonials'].url | default: '/pages/testimonials' }}" class="sidebar-dropdown-link">Success Stories</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Guides -->
        <div class="sidebar-item">
          <a href="{{ blogs['guides'].url | default: '/blogs/guides' }}" class="sidebar-link">
            Guides
            <svg class="sidebar-arrow" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
            </svg>
          </a>
          <div class="sidebar-dropdown">
            <div class="sidebar-dropdown-section">
              <h4>Hair Care Guides</h4>
              <div class="sidebar-dropdown-links">
                {%- if blogs.guides.articles.size > 0 -%}
                  {%- for article in blogs.guides.articles limit: 4 -%}
                    <a href="{{ article.url }}" class="sidebar-dropdown-link">{{ article.title }}</a>
                  {%- endfor -%}
                {%- else -%}
                  <a href="{{ routes.blog_url }}" class="sidebar-dropdown-link">Wash Day Routine</a>
                  <a href="{{ routes.blog_url }}" class="sidebar-dropdown-link">Styling Techniques</a>
                  <a href="{{ routes.blog_url }}" class="sidebar-dropdown-link">Night Time Routine</a>
                  <a href="{{ routes.blog_url }}" class="sidebar-dropdown-link">Seasonal Hair Care</a>
                {%- endif -%}
              </div>
            </div>
            <div class="sidebar-dropdown-section">
              <h4>Expert Advice</h4>
              <div class="sidebar-dropdown-links">
                <a href="{{ routes.blog_url }}/tagged/common-mistakes" class="sidebar-dropdown-link">Common Mistakes</a>
                <a href="{{ routes.blog_url }}/tagged/application" class="sidebar-dropdown-link">Product Application</a>
                <a href="{{ routes.blog_url }}/tagged/troubleshooting" class="sidebar-dropdown-link">Troubleshooting Guide</a>
                <a href="{{ routes.blog_url }}/tagged/pro-tips" class="sidebar-dropdown-link">Professional Tips</a>
              </div>
            </div>
          </div>
        </div>
      </nav>
      
      <div class="sidebar-actions">
        <a href="{{ routes.account_login_url }}" class="sidebar-action-link">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
          </svg>
          <span>Account</span>
        </a>
        <a href="{{ routes.search_url }}" class="sidebar-action-link">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
          </svg>
          <span>Search</span>
        </a>
      </div>
    </div>
  </aside>

  <!-- Content Wrapper -->
  <div class="content-wrapper">
    {% section 'announcement-bar' %}
    {% section 'header' %}
    
    <main>
      {{ content_for_layout }}
    </main>

    {% section 'footer' %}
  </div>
  
  <!-- Sidebar CSS -->
  <style>
    /* Sidebar Styles */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9998;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .sidebar-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: -100%;
      width: 320px;
      max-width: 90%;
      height: 100vh;
      background: #fff;
      z-index: 9999;
      box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar.active {
      left: 0;
    }

    /* Desktop specific sidebar behavior */
    @media (min-width: 1025px) {
      .sidebar {
        width: 350px;
        transform: translateX(-100%);
        transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
      }

      .sidebar.desktop-auto-show {
        transform: translateX(0);
        left: 0;
        box-shadow: none;
        border-right: 1px solid rgba(0, 0, 0, 0.08);
      }

      .sidebar-overlay {
        display: none;
      }
      
      /* Adjust header width on desktop when sidebar is visible */
      .header-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
        transition: margin-left 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
      }
      
      body.sidebar-desktop-visible .header-container {
        margin-left: 350px;
        max-width: calc(1400px - 350px);
      }
      
      /* Adjust main content containers */
      main .shopify-section > .section-container,
      main .page-width,
      main .container {
        transition: margin-left 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
      }
      
      body.sidebar-desktop-visible main .shopify-section > .section-container,
      body.sidebar-desktop-visible main .page-width,
      body.sidebar-desktop-visible main .container {
        margin-left: 350px;
      }
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      height: 80px;
      flex-shrink: 0;
      background: #fafafa;
    }

    .sidebar-logo img {
      height: 40px;
      width: auto;
      max-width: 120px;
      object-fit: contain;
    }

    .sidebar-close {
      background: none;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #333;
      transition: all 0.3s ease;
    }

    .sidebar-close:hover {
      background: rgba(232, 196, 184, 0.1);
      color: #E8C4B8;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .sidebar-nav {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sidebar-item {
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .sidebar-link {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      text-decoration: none;
      color: #333;
      font-weight: 500;
      font-size: 16px;
      transition: color 0.3s ease;
      cursor: pointer;
    }

    .sidebar-link:hover {
      color: #E8C4B8;
    }

    .sidebar-arrow {
      transition: transform 0.3s ease;
    }

    .sidebar-item.active .sidebar-arrow {
      transform: rotate(180deg);
    }

    .sidebar-dropdown {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
      padding-left: 15px;
    }

    .sidebar-item.active .sidebar-dropdown {
      max-height: 1000px;
    }

    .sidebar-dropdown-section {
      margin-bottom: 20px;
    }

    .sidebar-dropdown-section h4 {
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
      color: #666;
    }

    .sidebar-dropdown-links {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sidebar-dropdown-link {
      display: block;
      padding: 10px 0;
      text-decoration: none;
      color: #666;
      font-size: 14px;
      transition: all 0.3s ease;
      border-bottom: 1px solid transparent;
    }

    .sidebar-dropdown-link:hover {
      color: #E8C4B8;
      border-bottom-color: #E8C4B8;
      padding-left: 8px;
    }

    .sidebar-actions {
      padding-top: 30px;
      border-top: 1px solid rgba(0, 0, 0, 0.08);
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .sidebar-action-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      text-decoration: none;
      color: #333;
      font-size: 15px;
      transition: color 0.3s ease;
    }

    .sidebar-action-link:hover {
      color: #E8C4B8;
    }

    /* Mobile specific */
    @media (max-width: 1024px) {
      .sidebar {
        width: 300px;
      }
      
      .sidebar-header {
        padding: 15px;
        height: 70px;
      }
      
      .sidebar-content {
        padding: 15px;
      }
      
      .sidebar-link {
        padding: 14px 0;
        font-size: 15px;
      }
      
      /* Mobile overlay behavior */
      body.sidebar-open {
        overflow: hidden;
      }
      
      body.sidebar-open .content-wrapper {
        transform: translateX(300px);
        transition: transform 0.3s ease;
      }
    }

    @media (max-width: 480px) {
      .sidebar {
        width: 280px;
        max-width: 85%;
      }
      
      body.sidebar-open .content-wrapper {
        transform: translateX(280px);
      }
    }

    /* Hide scrollbar */
    .sidebar-content::-webkit-scrollbar {
      width: 0;
      background: transparent;
    }

    .sidebar-content {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
  </style>
  
  <!-- Sidebar JavaScript -->
  <script>
    // CRITICAL: CREATE SHOPIFY OBJECT WITH ALL NECESSARY PROPERTIES
    window.Shopify = window.Shopify || {
      shop: '{{ shop.permanent_domain }}',
      currency: {{ shop.money_format | json }},
      locale: '{{ request.locale.iso_code }}',
      routes: {
        cart: '{{ routes.cart_url }}',
        cart_add_url: '{{ routes.cart_add_url }}',
        cart_change_url: '{{ routes.cart_change_url }}',
        cart_clear_url: '{{ routes.cart_clear_url }}',
        root: '{{ routes.root_url }}'
      }
    };
    console.log('Shopify object initialized:', window.Shopify.shop ? 'SUCCESS' : 'FAILED');
    
    class SidebarMenu {
      constructor() {
        this.sidebar = document.getElementById('mainSidebar');
        this.sidebarOverlay = document.getElementById('sidebarOverlay');
        this.sidebarClose = document.getElementById('sidebarClose');
        this.sidebarItems = document.querySelectorAll('.sidebar-item');
        this.sidebarLinks = document.querySelectorAll('.sidebar-link');
        this.isDesktop = window.innerWidth > 1024;
        this.isSidebarVisible = false;
        
        this.init();
      }

      init() {
        this.bindEvents();
        this.listenToHeaderEvents();
        this.handleResize();
      }

      bindEvents() {
        if (this.sidebarOverlay) {
          this.sidebarOverlay.addEventListener('click', () => {
            this.closeSidebar();
          });
        }

        if (this.sidebarClose) {
          this.sidebarClose.addEventListener('click', () => {
            this.closeSidebar();
          });
        }

        // Toggle dropdowns
        this.sidebarLinks.forEach(link => {
          if (link.nextElementSibling && link.nextElementSibling.classList.contains('sidebar-dropdown')) {
            link.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              const parent = link.parentElement;
              const isActive = parent.classList.contains('active');
              
              this.sidebarItems.forEach(item => {
                if (item !== parent) {
                  item.classList.remove('active');
                }
              });
              
              parent.classList.toggle('active');
              
              if (!isActive) {
                const dropdown = parent.querySelector('.sidebar-dropdown');
                dropdown.style.maxHeight = dropdown.scrollHeight + 'px';
              } else {
                parent.querySelector('.sidebar-dropdown').style.maxHeight = '0';
              }
            });
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.isSidebarVisible) {
            this.closeSidebar();
          }
        });
      }

      listenToHeaderEvents() {
        document.addEventListener('toggleSidebar', () => {
          this.toggleSidebar();
        });

        document.addEventListener('showSidebarOnScroll', () => {
          if (this.isDesktop) {
            this.showSidebarDesktop();
          }
        });

        document.addEventListener('hideSidebarOnScroll', () => {
          if (this.isDesktop) {
            this.hideSidebarDesktop();
          }
        });
      }

      toggleSidebar() {
        if (this.isSidebarVisible) {
          this.closeSidebar();
        } else {
          this.openSidebar();
        }
      }

      openSidebar() {
        this.sidebar.classList.add('active');
        if (this.sidebarOverlay) this.sidebarOverlay.classList.add('active');
        if (!this.isDesktop) {
          document.body.classList.add('sidebar-open');
        }
        document.body.style.overflow = 'hidden';
        this.isSidebarVisible = true;
      }

      closeSidebar() {
        this.sidebar.classList.remove('active');
        if (this.sidebarOverlay) this.sidebarOverlay.classList.remove('active');
        document.body.classList.remove('sidebar-open', 'sidebar-desktop-visible');
        document.body.style.overflow = '';
        this.isSidebarVisible = false;
        
        this.sidebarItems.forEach(item => {
          item.classList.remove('active');
          const dropdown = item.querySelector('.sidebar-dropdown');
          if (dropdown) dropdown.style.maxHeight = '0';
        });
      }

      showSidebarDesktop() {
        if (!this.isDesktop) return;
        
        this.sidebar.classList.add('desktop-auto-show');
        document.body.classList.add('sidebar-desktop-visible');
        this.isSidebarVisible = true;
        
        if (this.sidebarOverlay) this.sidebarOverlay.style.display = 'none';
        
        // Adjust container widths
        this.adjustContentContainers();
        
        this.sidebarItems.forEach(item => {
          item.classList.remove('active');
          const dropdown = item.querySelector('.sidebar-dropdown');
          if (dropdown) dropdown.style.maxHeight = '0';
        });
      }

      hideSidebarDesktop() {
        if (!this.isDesktop) return;
        
        this.sidebar.classList.remove('desktop-auto-show');
        document.body.classList.remove('sidebar-desktop-visible');
        this.isSidebarVisible = false;
        
        if (this.sidebarOverlay) this.sidebarOverlay.style.display = 'block';
        
        // Reset container widths
        this.resetContentContainers();
      }

      adjustContentContainers() {
        // Find common container classes and adjust them
        const containerSelectors = [
          '.page-width',
          '.container',
          '.shopify-section > div[class*="container"]',
          '.shopify-section > .section',
          '[class*="__container"]'
        ];
        
        containerSelectors.forEach(selector => {
          const containers = document.querySelectorAll(selector);
          containers.forEach(container => {
            if (!container.hasAttribute('data-original-margin')) {
              container.setAttribute('data-original-margin', container.style.marginLeft || '');
            }
            container.style.marginLeft = '350px';
            container.style.transition = 'margin-left 0.4s cubic-bezier(0.165, 0.84, 0.44, 1)';
            
            // Adjust width if needed
            const currentWidth = container.style.width || getComputedStyle(container).width;
            if (!container.hasAttribute('data-original-width')) {
              container.setAttribute('data-original-width', currentWidth);
            }
            if (container.classList.contains('page-width')) {
              container.style.maxWidth = `calc(100% - 350px)`;
            }
          });
        });
      }

      resetContentContainers() {
        const containerSelectors = [
          '.page-width',
          '.container',
          '.shopify-section > div[class*="container"]',
          '.shopify-section > .section',
          '[class*="__container"]'
        ];
        
        containerSelectors.forEach(selector => {
          const containers = document.querySelectorAll(selector);
          containers.forEach(container => {
            const originalMargin = container.getAttribute('data-original-margin');
            container.style.marginLeft = originalMargin || '';
            
            const originalWidth = container.getAttribute('data-original-width');
            if (originalWidth) {
              container.style.width = originalWidth;
              container.style.maxWidth = originalWidth.includes('max-width') ? originalWidth : '';
            }
          });
        });
      }

      handleResize() {
        window.addEventListener('resize', () => {
          const wasDesktop = this.isDesktop;
          this.isDesktop = window.innerWidth > 1024;
          
          if (wasDesktop !== this.isDesktop) {
            this.closeSidebar();
            this.sidebar.classList.remove('desktop-auto-show');
            document.body.classList.remove('sidebar-desktop-visible');
            this.resetContentContainers();
            
            if (this.sidebarOverlay) {
              this.sidebarOverlay.style.display = 'block';
            }
          }
        });
      }
    }

      // ENHANCED UNIVERSAL BUTTON HANDLER WITH VARIANT DETECTION
    class UniversalButtonHandler {
      constructor() {
        this.productCache = {}; // Cache product data
        this.init();
      }
      
      init() {
        console.log('Enhanced UniversalButtonHandler initialized');
        
        // Listen to ALL clicks on page
        document.addEventListener('click', (e) => {
          this.handleClick(e);
        }, true);
        
        // Fix buttons that load dynamically
        this.setupMutationObserver();
        
        // Pre-fetch product data for current page
        this.prefetchProductData();
      }
      
      handleClick(event) {
        const target = event.target;
        const element = target.closest('button, a, [data-add-to-cart], .btn, .button, .add-to-cart-btn');
        
        if (!element) return;
        
        const text = (element.textContent || '').toLowerCase().trim();
        const id = element.id || '';
        
        // 1. HANDLE ADD TO CART BUTTONS
        if (text.includes('add to cart') || 
            text.includes('add to bag') ||
            element.hasAttribute('data-add-to-cart') ||
            (element.href && element.href.includes('/cart/add')) ||
            id.includes('add-to-cart') ||
            element.classList.contains('add-to-cart-btn')) {
          
          event.preventDefault();
          event.stopPropagation();
          console.log('Add to cart button detected:', element.textContent.trim());
          
          this.handleAddToCart(element);
          return false;
        }
        
        // 2. HANDLE BOOK APPOINTMENT BUTTONS
        if (text.includes('book') && 
            (text.includes('appointment') || text.includes('service') || text.includes('session'))) {
          
          event.preventDefault();
          event.stopPropagation();
          console.log('Book appointment button detected');
          
          this.handleBookAppointment(element);
          return false;
        }
      }
      
      handleAddToCart(element) {
        console.log('Processing add to cart for element:', element);
        
        // Try ALL methods to get variant ID
        let variantId = null;
        let quantity = 1;
        
        // Method 1: Direct data attributes
        variantId = element.dataset.variantId || 
                    element.dataset.productId ||
                    element.closest('[data-variant-id]')?.dataset.variantId ||
                    element.closest('[data-product-id]')?.dataset.productId;
        
        // Method 2: Form inputs
        if (!variantId) {
          const form = element.closest('form');
          if (form) {
            const idInput = form.querySelector('[name="id"], [name="variant"], input[name*="id"]');
            if (idInput) variantId = idInput.value;
          }
        }
        
        // Method 3: URL parameters from href
        if (!variantId && element.href) {
          try {
            const url = new URL(element.href, window.location.origin);
            variantId = url.searchParams.get('id') || 
                       url.searchParams.get('variant') || 
                       url.searchParams.get('product');
          } catch (e) {
            console.log('Could not parse URL');
          }
        }
        
        // Method 4: Product card/container data
        if (!variantId) {
          const container = element.closest('[data-product-handle], [data-product], .product-card, .product-item');
          if (container) {
            // Check data attributes on container
            variantId = container.dataset.variantId || 
                       container.dataset.productId ||
                       container.dataset.id;
            
            // If still no ID but we have handle, fetch it
            if (!variantId && container.dataset.productHandle) {
              this.fetchProductByHandle(container.dataset.productHandle, element);
              return;
            }
          }
        }
        
        // Method 5: Look for hidden inputs near the button
        if (!variantId) {
          const siblingInput = element.previousElementSibling || element.nextElementSibling;
          if (siblingInput && siblingInput.tagName === 'INPUT' && siblingInput.type === 'hidden') {
            variantId = siblingInput.value;
          }
        }
        
        // Method 6: Scan the entire product card for any ID
        if (!variantId) {
          const card = element.closest('.product-card, .card, .grid-item, .collection-item');
          if (card) {
            // Look for any element with variant/product ID
            const idElements = card.querySelectorAll('[data-variant-id], [data-product-id], [data-id]');
            for (const el of idElements) {
              variantId = el.dataset.variantId || el.dataset.productId || el.dataset.id;
              if (variantId) break;
            }
          }
        }
        
        if (variantId) {
          console.log('Found variant ID:', variantId);
          this.addToCartAPI(variantId, quantity);
        } else {
          console.warn('Could not find variant ID, trying product handle detection');
          
          // Last resort: Try to extract product handle from page
          const productHandle = this.extractProductHandleFromPage(element);
          if (productHandle) {
            this.fetchProductByHandle(productHandle, element);
          } else {
            this.showMessage('Unable to add item. Please visit the product page.', 'error');
            
            // Try to find and go to product page
            this.redirectToProductPage(element);
          }
        }
      }
      
      extractProductHandleFromPage(element) {
        // Try to find product handle from URL
        const path = window.location.pathname;
        if (path.includes('/products/')) {
          return path.split('/products/')[1].split('/')[0];
        }
        
        // Try to find from data attributes
        const container = element.closest('[data-product-handle], [data-product]');
        if (container && container.dataset.productHandle) {
          return container.dataset.productHandle;
        }
        
        // Try to find from link
        const productLink = element.closest('a[href*="/products/"]');
        if (productLink && productLink.href) {
          const match = productLink.href.match(/products\/([^\/]+)/);
          return match ? match[1] : null;
        }
        
        return null;
      }
      
      fetchProductByHandle(productHandle, element) {
        console.log('Fetching product by handle:', productHandle);
        
        // Check cache first
        if (this.productCache[productHandle]) {
          console.log('Using cached product data');
          const variantId = this.productCache[productHandle].variants[0]?.id;
          if (variantId) {
            this.addToCartAPI(variantId, 1);
          } else {
            this.showMessage('Product not available', 'error');
          }
          return;
        }
        
        // Show loading message
        this.showMessage('Loading product...', 'info');
        
        fetch(`/products/${productHandle}.js`)
          .then(res => {
            if (!res.ok) throw new Error('Product not found');
            return res.json();
          })
          .then(product => {
            // Cache the product data
            this.productCache[productHandle] = product;
            
            if (product.variants && product.variants.length > 0) {
              const variantId = product.variants[0].id;
              console.log('Fetched variant ID:', variantId);
              this.addToCartAPI(variantId, 1);
            } else {
              this.showMessage('Product has no available variants', 'error');
            }
          })
          .catch(err => {
            console.error('Failed to fetch product:', err);
            this.showMessage('Error loading product. Please visit the product page.', 'error');
            this.redirectToProductPage(element);
          });
      }
      
      prefetchProductData() {
        // Pre-fetch product data for current page
        if (window.location.pathname.includes('/collections/') || 
            window.location.pathname.includes('/products/')) {
          
          // Find all product handles on page
          const productElements = document.querySelectorAll('[data-product-handle], a[href*="/products/"]');
          const handles = new Set();
          
          productElements.forEach(el => {
            const handle = el.dataset?.productHandle || 
                          el.href?.match(/products\/([^\/]+)/)?.[1];
            if (handle) handles.add(handle);
          });
          
          // Pre-fetch first few products
          Array.from(handles).slice(0, 5).forEach(handle => {
            if (!this.productCache[handle]) {
              fetch(`/products/${handle}.js`)
                .then(res => res.json())
                .then(product => {
                  this.productCache[handle] = product;
                })
                .catch(err => console.log('Prefetch failed for:', handle));
            }
          });
        }
      }
      
      redirectToProductPage(element) {
        // Try to find product page link
        const productLink = element.closest('a[href*="/products/"]') || 
                           element.closest('[data-product-url]') ||
                           document.querySelector('a[href*="/products/"]');
        
        if (productLink) {
          const url = productLink.href || productLink.dataset.productUrl;
          if (url) {
            setTimeout(() => {
              window.location.href = url;
            }, 1000);
          }
        }
      }
      
      addToCartAPI(variantId, quantity) {
        console.log('Adding to cart - Variant:', variantId, 'Qty:', quantity);
        
        // Validate variant ID
        if (!variantId || isNaN(variantId)) {
          this.showMessage('Invalid product selection', 'error');
          return;
        }
        
        this.showMessage('Adding to cart...', 'info');
        
        fetch('/cart/add.js', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({
            items: [{ id: variantId.toString(), quantity: quantity }]
          })
        })
        .then(response => {
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return response.json();
        })
        .then(data => {
          console.log('✅ Cart add success:', data);
          this.showMessage('Added to cart!', 'success');
          
          // Update cart count in header
          this.updateCartCount(data.item_count);
          
          // Redirect to cart after delay
          setTimeout(() => {
            window.location.href = '/cart';
          }, 1500);
        })
        .catch(error => {
          console.error('❌ Cart add failed:', error);
          
          // Try alternative method
          this.tryAlternativeCartMethod(variantId, quantity, error);
        });
      }
      
      tryAlternativeCartMethod(variantId, quantity, originalError) {
        console.log('Trying alternative cart method...');
        
        // Method 2: Use form submission
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/cart/add';
        form.style.display = 'none';
        
        const idInput = document.createElement('input');
        idInput.type = 'hidden';
        idInput.name = 'id';
        idInput.value = variantId;
        
        const qtyInput = document.createElement('input');
        qtyInput.type = 'hidden';
        qtyInput.name = 'quantity';
        qtyInput.value = quantity;
        
        form.appendChild(idInput);
        form.appendChild(qtyInput);
        document.body.appendChild(form);
        
        // Try to submit form
        setTimeout(() => {
          form.submit();
        }, 500);
        
        // If form doesn't work, show error
        setTimeout(() => {
          this.showMessage('Failed to add to cart. Please try again or contact support.', 'error');
          console.error('All cart methods failed:', originalError);
        }, 2000);
      }
      
      updateCartCount(count) {
        // Update any cart count elements
        const countElements = document.querySelectorAll('.cart-count, [data-cart-count], .header__cart-count');
        countElements.forEach(el => {
          if (el.tagName === 'SPAN' || el.tagName === 'DIV') {
            el.textContent = count;
          } else if (el.tagName === 'INPUT') {
            el.value = count;
          }
        });
      }
      
      handleBookAppointment(element) {
        let bookingUrl = element.href || 
                        element.dataset.bookingUrl ||
                        '/pages/book-now';
        
        console.log('Redirecting to booking:', bookingUrl);
        window.location.href = bookingUrl;
      }
      
      showMessage(text, type) {
        // Remove existing messages
        document.querySelectorAll('.universal-button-message').forEach(msg => msg.remove());
        
        const message = document.createElement('div');
        message.className = 'universal-button-message';
        message.textContent = text;
        message.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${type === 'success' ? '#E8C4B8' : type === 'error' ? '#ff4444' : '#666'};
          color: white;
          padding: 12px 24px;
          border-radius: 4px;
          z-index: 99999;
          font-weight: bold;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          animation: slideIn 0.3s ease;
        `;
        
        document.body.appendChild(message);
        
        setTimeout(() => {
          message.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => message.remove(), 300);
        }, 3000);
      }
      
      setupMutationObserver() {
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.addedNodes.length) {
              console.log('New elements added to DOM');
              // Re-check for product data
              this.prefetchProductData();
            }
          });
        });
        
        observer.observe(document.body, {
          childList: true,
          subtree: true
        });
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize sidebar
      setTimeout(() => {
        const sidebar = new SidebarMenu();
        window.sidebarInstance = sidebar;
      }, 100);
      
      // Initialize universal button handler
      setTimeout(() => {
        window.universalButtonHandler = new UniversalButtonHandler();
        console.log('All button handlers loaded');
      }, 200);
      
      // Quick test
      console.log('Page loaded. Testing Shopify:', typeof Shopify !== 'undefined' ? 'OK' : 'MISSING');
    });
  </script>
</body>
</html>